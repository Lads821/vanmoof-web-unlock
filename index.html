<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VanMoof Unlock</title>
</head>
<body>
  <h1>üîê –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ VanMoof</h1>
  <button id="connect">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥</button>
  <pre id="log" style="background:#eee; padding:1em;"></pre>

  <script>
    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\n";
    };

    function hexStringToByteArray(hex) {
      const result = [];
      for (let i = 0; i < hex.length; i += 2) {
        result.push(parseInt(hex.substr(i, 2), 16));
      }
      return new Uint8Array(result);
    }

    document.getElementById('connect').addEventListener('click', async () => {
      const keyHex = prompt("–í–≤–µ–¥–∏ unlock key (16 –±–∞–π—Ç –≤ hex, –Ω–∞–ø—Ä–∏–º–µ—Ä 2b17bc04...):");
      if (!keyHex || keyHex.length !== 32) {
        alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á (–æ–∂–∏–¥–∞–µ—Ç—Å—è 32 hex —Å–∏–º–≤–æ–ª–∞)");
        return;
      }

      try {
        log("üîç –ü–æ–∏—Å–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞...");
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'VANMOOF' }],
          optionalServices: [0xfee0]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(0xfee0);
        const characteristic = await service.getCharacteristic('00000004-0000-1000-8000-00805f9b34fb');

        const payload = hexStringToByteArray(keyHex);
        await characteristic.writeValue(payload);
        log("‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!");
      } catch (err) {
        log("‚ùå –û—à–∏–±–∫–∞: " + err.message);
      }
    });
  </script>
</body>
</html>
