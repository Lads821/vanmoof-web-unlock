<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üîì VanMoof –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ –°–∫–æ—Ä–æ—Å—Ç—å</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; }
    h1 { font-size: 18px; }
    input, button, select { margin: 6px 0; padding: 10px; font-size: 14px; }
    #log { white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
  </style>
</head>
<body>

<h1>üîê –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ VanMoof</h1>

<label for="serviceUuid">UUID —Å–µ—Ä–≤–∏—Å–∞ (—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞):</label><br>
<select id="serviceUuid">
  <option value="8e7f1a50-087a-44c9-b292-a2c628fdd9aa">8e7f1a50-087a-44c9-b292-a2c628fdd9aa</option>
</select><br>

<input id="keyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ 32-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–ª—é—á" size="40"><br>
<button onclick="unlockBike()">üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥</button><br><br>

<button onclick="setSpeed(25)">üö≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç 25 –∫–º/—á</button>
<button onclick="setSpeed(32)">üöÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç 32 –∫–º/—á</button><br><br>

<div id="log">–ì–æ—Ç–æ–≤–æ.</div>

<script>
const log = msg => {
  const box = document.getElementById("log");
  box.textContent += "\n[" + new Date().toLocaleTimeString() + "] " + msg;
  box.scrollTop = box.scrollHeight;
};

async function unlockBike() {
  log("üîç –ü–æ–∏—Å–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞...");
  try {
    const serviceUuid = document.getElementById('serviceUuid').value;
    const key = document.getElementById("keyInput").value.trim();
    if (!/^[0-9a-fA-F]{32}$/.test(key)) {
      log("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á (–æ–∂–∏–¥–∞–µ—Ç—Å—è 32 hex —Å–∏–º–≤–æ–ª–∞)");
      return;
    }

    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'VANMOOF' }],
      optionalServices: [serviceUuid]
    });

    log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ " + device.name + "...");
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);

    // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (WRITE)
    const characteristic = await service.getCharacteristic("8e7f1a53-087a-44c9-b292-a2c628fdd9aa");
    const bytes = new Uint8Array(key.match(/.{1,2}/g).map(b => parseInt(b, 16)));

    await characteristic.writeValueWithoutResponse(bytes);
    log("‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!");
  } catch (e) {
    log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ: " + e.message);
  }
}

async function setSpeed(kmh) {
  const targetSpeed = kmh === 32 ? "–°–®–ê" : "–ï–°";
  log("‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–∞ " + kmh + " –∫–º/—á (" + targetSpeed + ")...");
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'VANMOOF' }],
      optionalServices: ["f000ffc0-0451-4000-b000-000000000000"]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("f000ffc0-0451-4000-b000-000000000000");
    const characteristic = await service.getCharacteristic("f000ffc3-0451-4000-b000-000000000000");

    const hex = kmh === 32
      ? "0f0d0000000000000000000000000000"
      : "00000000000000000000000000000000";

    const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));

    await characteristic.writeValue(bytes);
    log("‚úÖ –õ–∏–º–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: " + kmh + " –∫–º/—á");
  } catch (e) {
    log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–∏–º–∏—Ç–∞: " + e.message);
  }
}
</script>

</body>
</html>




